#!/usr/bin/python

"""muse - Muse Audio File Manager

Usage: muse -c|--cmp [-q] [[<music>] <backup>]
       muse -d|--dedup [-q] [-f|-n] [<music>]
       muse -h|--help
       muse -l|--load [-q] [<backup> [<music>]]
       muse -r|--reconcile [-q] [-n] [<music>]
       muse -t|--tags [-q] [<music>]
       muse --version

Options:
    -c --cmp        Compare two files or libraries
    -d --dedup      Search for and removes duplicate files in a music libary (default: ~/Music)
    -f --force      Force deduplication even if files are different sizes
    -h --help       Show this screen
    -l --load       Load music from a backup
    -n --noaction   Just tells you what a command would do without taking any action
    -q --quiet      Suppress warnings
    -r --reconcile  Reconcile directories, file names and tags of a music file or library
    -t --tags       List the tags of a music file or library
       --version    Show the version
"""

import filecmp
import os
import sys

sys.path.append(os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), "lib"))
from docopt       import docopt
from muse.Factory import createAudioFile
from muse.Mp3File import Mp3FileError
from muse.Options import options

arguments = docopt(__doc__, version='1.0')
music = arguments['<music>'] if arguments['<music>'] else os.path.join(os.path.expanduser("~"), "Music")
options["warning"] = not arguments['--quiet']
options["force"  ] = arguments['--force']

if arguments['--cmp']:
    backup = arguments['<backup>'] if arguments['<backup>'] else "/mnt/wdtvlivehub/Music"
else:
    backup = None

if os.path.isfile(music):
    if arguments['--cmp']:
        file1 = createAudioFile(music)
        file2 = createAudioFile(backup)
        file1.isPreferredTo(file2)
        
    elif arguments['--reconcile']:
        file1 = createAudioFile(music)
        file1.reconcile()
    
    elif arguments['--tags']:
        file1 = createAudioFile(music)
        file1.readFile()
        
        for frameId in file1.frames.keys():
            print frameId + ":" + file1.frames[frameId]

    sys.exit(0)
    
if arguments['--cmp'] and not os.path.exists(music):
    os.mkdir(music)
    
if arguments['--cmp'] and not os.path.exists(backup):
    os.mkdir(backup)
  
os.chdir(music)
allFiles    = {}
filesBySize = {}
remoteFiles = {}
localFiles  = {}
missingRoot = None

for dirPath, subDirs, files in os.walk("."):
    relPath = dirPath[1:]
    
    if backup and not os.path.isdir(backup + relPath):
        if relPath.endswith("/.mediaartlocal"):
            continue
            
        if missingRoot == None or not relPath.startswith(missingRoot):
            print backup + " does not contain directory " + relPath
            missingRoot = relPath
    else:
        missingRoot = None
        
    for file in files:
        filePath  = dirPath + "/" + file

        try:
            audioFile = createAudioFile(filePath)

            if not audioFile:
                continue
                
            key = file.lower()
    
            if key in allFiles:
                otherFile = allFiles[key]
                score     = audioFile.isPreferredTo(otherFile)
                
                if arguments["--noaction"]:
                    if score < 0:
                        print "%s is prefered to %s by %d points" % (file.filePath, otherFile.filePath, -score)
                    elif score > 0:
                        print "%s is prefered to %s by %d points" % (otherFile.filePath, file.filePath, -score)
                
                elif score < 0:
                    otherFile.remove()
                elif score > 0:
                    file.remove()
                else:
                    print "Can't choose between %s and %s (try -fn to see what force would do)" % (ile.filePath, otherFile.filePath)
                    
            else:
                allFiles[key] = audioFile
            
            if arguments["--reconcile"]:
                audioFile.reconcile()
                
            if backup and not os.path.isfile(backup + relPath + "/" + file):
                if not missingRoot:
                    print backup + relPath + " does not contain file " + file
        
        except Mp3FileError as error:
            print "Skipping invalid MP3 file: " + str(error)
            continue
                
sys.exit(0)
